<include file="public@header" />
</head>
<body>
	<div class="wrap">
		<ul class="nav nav-tabs"> 
			<include file="public@nav" />
			<li class="active"><a href="{:url('edit',['id'=>$info.id])}">编辑{$flag}</a></li>  
		 
		</ul>
		<form class="form-horizontal js-ajax-form{$zzajax} margin-top-20" role="form" method="post" action="{:url('edit_do')}">
			  <include file="order@admin_order:base" />
			
		 
			<div class="form-group">
				<div class="col-sm-offset-2 col-sm-10"> 
				 
					<button type="submit" class="save btn btn-primary js-ajax-submit" >提交编辑信息</button>
					 'order_status' => 
  array ( 
      1=>'未提交',
      2=>'提交待审核',
    10 => '待付款',
    20 => '待发货',
    22 => '已准备发货',
    24 => '已发货',
    26 => '已收货',
    30 => '订单完成',
    40 => '退货中',
    42 => '退货完成',
    80 => '取消订单',
    81 => '废弃订单', 
  ),
					 <switch name="info.status">
						 <case value="1">
						 	<button type="submit" class="save2 btn btn-primary js-ajax-submit" >提交订单</button>
						 </case>
						 <case value="2">
						 	<button type="submit" class="save10 btn btn-primary js-ajax-submit" >提交订单</button>
						 </case>
					 </switch> 
					 <p class="notice">不同仓库发货的必须拆分订单。 已付款和已发货的订单不能再修改，只能拆分订单发货
					 <br/>用户在未发货前可以取消订单，管理员在用户未付款且未发货前可以废弃订单 
					 <br/>新添加的订单未提交前视为草稿，只有创建人本人可以编辑，编辑即时生效
					 <br/>订单总费用的更改只能在用户付款和公司发货前修改 
					 <br/>子订单是不显示用户付款信息和发票信息的，拆分订单只能到主订单下操作</p>
				</div>
				
			</div>
		</form>
	 
	</div>
	<script src="__STATIC__/js/admin.js"></script> 
</body>
</html>
<script>

var price_count=0;
var num_count=0; 
var price_real=0;
var pay=0;
var num=0; 
var weight_count=0;
var size_count=0;
var weight1=0;
var size1=0;
var $tmp_tr;
var weight0=0;
var size0=0;
  

city_js($('#province'),'{$info.province}',$('#city'),'{$info.city}',$('#area'),'{$info.area}');

$(document).on('change','.price_real input',function(){
	tr_change($(this).parents('tr'),'price');
});
$(document).on('change','.size1,.weight1',function(){ 
	order_change($(this).parents('.order'),'num');
});
var url_freight_count="{:url('order/Orderajax/freight_count')}";
$(document).on('click','.freight_count',function(){
	 
	var $div=$(this).parents('.order');
	var store=$div.find('.store').val();
	var freight=$div.find('.freight').val();
	var weight=$div.find('.order_weight').val();
	var size=$div.find('.order_size').val();
	if(!(store>0)){
		msg('先选择发货仓库');
		return false;
	}
	if(!(freight>0)){
		msg('先选择合作快递公司');
		return false;
	} 
	if(!(weight>0) || !(size>0)){
		msg('先填写重量和体积');
		return false;
	} 
	 
	var city=$('#city').val();
	 
	$.ajax({
        type: 'POST',
        url: url_freight_count,
        dataType: 'json', 
        data:{'freight':freight,'city':city,'size':size,'weight':weight},
        success: function (data) {
     	    if(data.code!=1){
     	    	msg(data.msg);
     	    	return false;
     	    }  
     	    $div.find('.real_freight').val(data.data);
     	    if(($.trim($div.find('.pay_freight').val()))==''){
     	    	$div.find('.pay_freight').val(data.data);
     	    } 
        }, 
        error: function (event, XMLHttpRequest, ajaxOptions, thrownError) { 
            msg(event.responseText,1);
        }
    }); 
});
$(document).on('change','.discount_money,.other_money,.pay_freight,.tax_money',function(){ 
	var $div=$(this).parents('.order_pay');
	money_count($div);
	 if(!(($div.attr('id'))=='order_pay')){ 
		 orders_account();
	 }
	
});
 
 
 
//产品价格变化或重量变化,本行的变化
function tr_change($tr,type='price'){  
	num=parseInt($tr.find('.num input').val()); 
	price_real=parseFloat($tr.find('.price_real input').val());
	 
	if(!(num>0)){
		num=0;
	} 
	if(!(price_real>0)){
		price_real=0;
	}
	price_real=price_real.toFixed(2);
	$tr.find('.price_real input').val(price_real);
	price_count=(num*price_real).toFixed(2);
	$tr.find('.pay input').val(price_count); 
	//重量体积改变
	if(type=='num'){
		weight0=$tr.find('.weight0').val();
		size0=$tr.find('.size0').val(); 
		$tr.find('.weight1').val((num*weight0).toFixed(2));
		$tr.find('.size1').val((num*size0).toFixed(2));  
	} 
	order_change($tr.parents('.order'),type);
	 
}
//一个订单内的计算统计
function order_change($div,type='price'){  
	price_count=0;
	num_count=0; 
	//订单div 
	$div.find('.pay').each(function(){
		$tmp_tr=$(this).parents('tr');  
		num=parseInt($tmp_tr.find('.num input').val()); 
		if(!(num>0)){
			num=0; 
			$tmp_tr.remove();
			 return true;
		} 
		num_count+=num; 
		pay=parseFloat($tmp_tr.find('.pay input').val()); 
		if(!(pay>0)){ 
			pay=0;
		}
		price_count+=pay; 
		
		//重量体积改变
		if(type=='num'){
			weight1=parseFloat($tmp_tr.find('.weight1').val());
			if(!(weight1>0)){
				weight1=0.01; 
			}
			$tmp_tr.find('.weight1').val(weight1.toFixed(2)); 
			weight_count+=weight1;
			size1=parseFloat($tmp_tr.find('.size1').val());
			if(!(size1>0)){
				size1=0.01; 
			}
			$tmp_tr.find('.size1').val(size1.toFixed(2));
			size_count+=size1;
		} 
		 
	});
	
	$div.find('.goods_money').val(price_count.toFixed(2));
	$div.find('.goods_num').val(num_count);
	if(type=='num'){
		$div.find('.order_size').val(size_count.toFixed(2));
		$div.find('.order_weight').val(weight_count.toFixed(2));
	} 
	money_count($div);
	orders_account();
}
//子订单变化触发总订单
function orders_account(){
	if(is_real==1){
		 
		return 0;
	}
	price_count=0;
	num_count=0; 
 
	$('.order').each(function(){ 
		pay=parseFloat($(this).find('.goods_money').val());
		if(!(pay>0)){
			pay=0; 
		}
		$(this).find('.goods_money').val(pay.toFixed(2)); 
		price_count+=pay; 
		
		num=parseInt($(this).find('.goods_num').val());
		if(!(num>0)){ 
			num=0;
		}
		num_count+=num;
	});
	
	$('#goods_money').val(price_count.toFixed(2));
	$('#goods_num').val(num_count.toFixed(2)); 
	
	money_count($('#goods_money').parents('.order_pay'));
} 
 
$('.save').click(function(){
	$('form').attr('action',"{:url('edit_do')}");
});
var oid=0;
var is_end=1;
var $order_new;
$('#break_ok').click(function(){
	is_end=1;
});
$('.order_break').click(function(){
	var div=''; 
	var num=0;
	var goods_id; 
	 
	$tmp_tr=$(this).parents('tr');
 
	num=parseInt($tmp_tr.find('.break').val());
	if(!(num>0)){ 
		$tmp_tr.find('.break').val(0);
		$tmp_tr.find('.break').focus();
		return 0;
	} 
	
	var num0=$tmp_tr.find('.num input').val();
  	if(num0<num){
  		$tmp_tr.find('.num input').focus();
		return 0;
  	} 
  	//如果是新拆分要把原订单的name值都改变
	if(is_real==1){
		is_real=2;
		$('#order_pay').show();
		var oid0=$('.oid').val();
		oid=oid-1;
		$('.order'+oid0).removeClass('order'+oid0).addClass('order'+oid);
		$('.oid').val(oid);
		$('.order_name').html('拆分订单'+oid);
		$order_new=$('.order'+oid);
		$order_new.find('.order_pay .store').attr('name','store0['+oid+']');
		$order_new.find('.order_pay .freight').attr('name','freight0['+oid+']');
		$order_new.find('.order_pay .order_weight').attr('name','weight0['+oid+']');
		$order_new.find('.order_pay .order_size').attr('name','size0['+oid+']');
		$order_new.find('.order_pay .pay_freight').attr('name','pay_freight0['+oid+']');
		$order_new.find('.order_pay .real_freight').attr('name','real_freight0['+oid+']');
		$order_new.find('.order_pay .goods_num').attr('name','goods_num0['+oid+']');
		$order_new.find('.order_pay .goods_money').attr('name','goods_money0['+oid+']');
		$order_new.find('.order_pay .discount_money').attr('name','discount_money0['+oid+']');
		$order_new.find('.order_pay .tax_money').attr('name','tax_money0['+oid+']');
		$order_new.find('.order_pay .other_money').attr('name','other_money0['+oid+']');
		$order_new.find('.order_pay .order_amount').attr('name','order_amount0['+oid+']');
		$order_new.find('.order_pay .dsc').attr('name','dsc0['+oid+']');
	 
		$('.price_real').each(function(){
			goods_id=$(this).parents('tr').find('.goods_id').val(); 
			 
			$order_new.find('.goods'+goods_id+' .goods_id').attr('name','goods_ids-'+oid+'['+goods_id+']');
			$order_new.find('.goods'+goods_id+' .price_real input').attr('name','price_reals-'+oid+'['+goods_id+']');
			$order_new.find('.goods'+goods_id+' .num input').attr('name','nums-'+oid+'['+goods_id+']');
			$order_new.find('.goods'+goods_id+' .pay input').attr('name','pays-'+oid+'['+goods_id+']');
			$order_new.find('.goods'+goods_id+' .weight1').attr('name','weights-'+oid+'['+goods_id+']');
			$order_new.find('.goods'+goods_id+' .size1').attr('name','sizes-'+oid+'['+goods_id+']');
			$order_new.find('.goods'+goods_id+' .dsc input').attr('name','dscs-'+oid+'['+goods_id+']');
	 	});
	}
	 
	goods_id=$tmp_tr.find('.goods_id').val(); 
	if(is_end==1){
		 
		oid=oid-1;
		div='<div class="order order'+oid+'" >'+
			'<input type="hidden" class="oid" value="'+oid+'" name="oids[]"/>'+
			'<table class="table table-hover table-bordered table-list goods-list"  ><tr >'+ 
		 	 '<td>新子订单'+oid+'</td>'+
		 	 '<td width="100">产品编码</td>'+
		 	 '<td width="100">产品图片</td>'+
		 	 '<td width="100">总库存</td>'+
		 	 '<td width="100">成本价</td>'+
			 '<td width="100">零售价</td> '+
			 '<td width="100">供应价</td>'+
			 '<td width="100">数量</td>'+
			 '<td width="100">金额</td>'+
			 '<td width="100">毛重</td>'+
			 '<td width="100">体积</td>'+
			 '<td >包装说明/备注</td>'+
			 '<td width="100">拆分</td></tr> </table></div>'; 
		$('.orders').append(div);
		$(this).parents('.order').find('.order_pay').clone(true).appendTo('.order'+oid);
		$order_new=$('.order'+oid);
	 	
		
		
		$order_new.find('.order_pay .store').attr('name','store0['+oid+']');
		$order_new.find('.order_pay .freight').attr('name','freight0['+oid+']');
		$order_new.find('.order_pay .order_weight').attr('name','weight0['+oid+']');
		$order_new.find('.order_pay .order_size').attr('name','size0['+oid+']');
		$order_new.find('.order_pay .pay_freight').attr('name','pay_freight0['+oid+']');
		$order_new.find('.order_pay .real_freight').attr('name','real_freight0['+oid+']');
		$order_new.find('.order_pay .goods_num').attr('name','goods_num0['+oid+']');
		$order_new.find('.order_pay .goods_money').attr('name','goods_money0['+oid+']');
		$order_new.find('.order_pay .discount_money').attr('name','discount_money0['+oid+']');
		$order_new.find('.order_pay .tax_money').attr('name','tax_money0['+oid+']');
		$order_new.find('.order_pay .other_money').attr('name','other_money0['+oid+']');
		$order_new.find('.order_pay .order_amount').attr('name','order_amount0['+oid+']');
		$order_new.find('.order_pay .dsc').attr('name','dsc0['+oid+']');
		
		$order_new.find('.order_pay select').val(0);
		$order_new.find('.order_pay input').val(0);
		$order_new.find('.order_pay select').val(0);
		$order_new.find('.order_pay dsc').val('');
		is_end=0;
	} 
	 
	
	
	if($order_new.find('.goods'+goods_id).length>0){
		$order_new.find('.goods'+goods_id+' .num input').val(parseInt($order_new.find('.goods'+goods_id+' .num input').val())+num);
	}else{
		$tmp_tr.clone().appendTo('.order'+oid+' .goods-list');
		 
		$order_new.find('.goods'+goods_id+' .goods_id').attr('name','goods_ids-'+oid+'['+goods_id+']');
		$order_new.find('.goods'+goods_id+' .price_real input').attr('name','price_reals-'+oid+'['+goods_id+']');
		$order_new.find('.goods'+goods_id+' .num input').attr('name','nums-'+oid+'['+goods_id+']');
		$order_new.find('.goods'+goods_id+' .pay input').attr('name','pays-'+oid+'['+goods_id+']');
		$order_new.find('.goods'+goods_id+' .weight1').attr('name','weights-'+oid+'['+goods_id+']');
		$order_new.find('.goods'+goods_id+' .size1').attr('name','sizes-'+oid+'['+goods_id+']');
		$order_new.find('.goods'+goods_id+' .dsc input').attr('name','dscs-'+oid+'['+goods_id+']');
	 
		$order_new.find('.goods'+goods_id+' .num input').val(num);
		$order_new.find('.goods'+goods_id+' .break').val(0);
	}
	 
	$tmp_tr.find('.break').val(0);
	 
  	$tmp_tr.find('.num input').val(num0-num);
  	tr_change($tmp_tr,'num');
	tr_change($order_new.find('.goods'+goods_id),'num');
	 
});

</script>