<include file="public@header" />
</head>
<body>
	<div class="wrap">
		<ul class="nav nav-tabs"> 
			<include file="public@nav" />
			<li class="active"><a href="{:url('edit',['id'=>$info.id])}">编辑{$flag}</a></li>  
		 
		</ul>
		<form class="form-horizontal js-ajax-form{$zzajax} margin-top-20" role="form" method="post" action="{:url('edit_do')}">
			  <include file="order@admin_order:base" />
			<div class="form-group fleft-all">
				<label   class="col-sm-2 control-label">审核状态</label>
				<div class="col-md-6 col-sm-10">
				 
				 <foreach name="statuss" item="vo">
				  	<label class="radio-inline">
				 		<input type="radio" value="{$key}" name="status" <if condition="$key eq $info.status">checked</if>/>{$vo}
				 	</label>
				 </foreach>
				</div>
			</div>
			<div class="form-group">
				<div class="col-sm-offset-2 col-sm-10"> 
				 
					<button type="submit" class="save btn btn-primary js-ajax-submit" >提交编辑信息</button>
					  
					 <p class="notice">不同仓库发货的必须拆分订单。 已付款和已发货的订单不能再修改，只能拆分订单发货
					 <br/>用户在未发货前可以取消订单，管理员在用户未付款且未发货前可以废弃订单 
					 <br/>订单总费用的更改只能在用户付款和公司发货前修改 
					 <br/>子订单是不显示用户付款信息和发票信息的，拆分订单只能到主订单下操作</p>
				</div>
				
			</div>
		</form>
	 
	</div>
	<script src="__STATIC__/js/admin.js"></script> 
</body>
</html>
<script>
//订单是否拆分
var is_break="{$info.is_real}";
var price_count=0;
var num_count=0; 
var price_real=0;
var pay=0;
var num=0; 
var weight_count=0;
var size_count=0;
var weight1=0;
var size1=0;
var $tmp_tr;
var weight0=0;
var size0=0;

$(document).on('change','.price_real input',function(){
	tr_change($(this).parents('tr'),'price');
});
$(document).on('change','.size1,.weight1',function(){ 
	order_change($(this).parents('.order'),'num');
});
var url_freight_count="{:url('order/Orderajax/freight_count')}";
$(document).on('click','.freight_count',function(){
	 
	var $div=$(this).parents('.order');
	var store=$div.find('.store').val();
	var freight=$div.find('.freight').val();
	var weight=$div.find('.order_weight').val();
	var size=$div.find('.order_size').val();
	if(!(store>0)){
		msg('先选择发货仓库');
		return false;
	}
	if(!(freight>0)){
		msg('先选择合作快递公司');
		return false;
	} 
	if(!(weight>0) || !(size>0)){
		msg('先填写重量和体积');
		return false;
	} 
	 
	var city=$('#city').val();
	 
	$.ajax({
        type: 'POST',
        url: url_freight_count,
        dataType: 'json', 
        data:{'freight':freight,'city':city,'size':size,'weight':weight},
        success: function (data) {
     	    if(data.code!=1){
     	    	msg(data.msg);
     	    	return false;
     	    }  
     	    $div.find('.real_freight').val(data.data);
     	    if(($.trim($div.find('.pay_freight').val()))==''){
     	    	$div.find('.pay_freight').val(data.data);
     	    } 
        }, 
        error: function (event, XMLHttpRequest, ajaxOptions, thrownError) { 
            msg(event.responseText,1);
        }
    }); 
});
$(document).on('click','.money_count',function(){
	var $div=$(this).parents('.order');
	var goods_money=parseFloat($div.find('.goods_money').val());
	var discount_money=parseFloat($div.find('.discount_money').val());
	var other_money=parseFloat($div.find('.other_money').val());
	var pay_freight=parseFloat($div.find('.pay_freight').val());
	var tax_money=parseFloat($div.find('.tax_money').val()); 
	if(!(goods_money>0)){
		goods_money=0;
		$div.find('.goods_money').val(0);
	}
	if(!(discount_money>0)){
		discount_money=0;
		$div.find('.discount_money').val(0);
	}
	if(!(other_money>0)){
		other_money=0;
		$div.find('.other_money').val(0);
	}
	if(!(pay_freight>0)){
		pay_freight=0;
		$div.find('.pay_freight').val(0);
	}
	if(!(tax_money>0)){
		tax_money=0;
		$div.find('.tax_money').val(0);
	}
	order_amount=goods_money-discount_money+other_money+pay_freight+tax_money;
	$div.find('.order_amount').val(order_amount.toFixed(2));
});
 
//产品价格变化或重量变化,本行的变化
function tr_change($tr,type='price'){  
	num=parseInt($tr.find('.num input').val()); 
	price_real=parseFloat($tr.find('.price_real input').val());
	if(!(num>0)){
		msg('产品数量错误');
		$tr.find('.price_real input').focus();
		return 0;
	} 
	if(!(price_real>=0)){
		msg('产品价格错误');
		$tr.find('.price_real input').focus();
		return 0;
	}
	price_real=price_real.toFixed(2);
	$tr.find('.price_real input').val(price_real);
	price_count=(num*price_real).toFixed(2);
	$tr.find('.pay input').val(price_count); 
	//重量体积改变
	if(type=='num'){
		weight0=$tr.find('.weight0').val();
		size0=$tr.find('.size0').val(); 
		$tr.find('.weight1').val((num*weight0).toFixed(2));
		$tr.find('.size1').val((num*size0).toFixed(2));  
	} 
	order_change($tr.parents('.order'),type);
}
//一个订单内的计算统计
function order_change($div,type='price'){  
	price_count=0;
	num_count=0; 
	//订单div 
	$div.find('.pay').each(function(){
		$tmp_tr=$(this).parents('tr'); 
		num=parseInt($tmp_tr.find('.num input').val()); 
		if(!(num>0)){
			msg('产品数量错误');
			$tmp_tr.find('.price_real input').focus();
			num=0; 
			return false;
		}
		 
		num_count+=num;
		 
		pay=parseFloat($tmp_tr.find('.pay input').val());
		 
		if(!(pay>=0)){
			msg('产品费用错误');
			$(this).focus();
			num=0; 
			return false;
		}
		price_count+=pay; 
		
		//重量体积改变
		if(type=='num'){
			weight1=parseFloat($tmp_tr.find('.weight1').val());
			if(!(weight1>0)){
				weight1=0.01;
				$tmp_tr.find('.weight1').val(weight1); 
			}
			weight_count+=weight1;
			size1=parseFloat($tmp_tr.find('.size1').val());
			if(!(size1>0)){
				size1=0.01;
				$tmp_tr.find('.size1').val(size1); 
			}
			size_count+=size1;
		}
		  
	});
	if(num==0){
		return false;
	}
	$div.find('.goods_money').val(price_count.toFixed(2));
	$div.find('.goods_num').val(num_count);
	if(type=='num'){
		$div.find('.order_size').val(size_count.toFixed(2));
		$div.find('.order_weight').val(weight_count.toFixed(2));
	} 
	 
	orders_account();
}
//子订单变化触发总订单
function orders_account(){
	price_count=0;
	num_count=0; 
 
	$('.order').each(function(){ 
		pay=parseFloat($(this).find('.goods_money').val());
		if(!(pay>=0)){
			pay=0;
			$(this).find('.goods_money').val(pay); 
		}
		price_count+=pay;
		
		num=parseFloat($(this).find('.goods_num').val());
		if(!(pay>0)){
			msg('商品数量错误');
			$(this).find('.goods_money').focus();
			return 0; 
		}
		num_count+=num;
		 
	});
	if(num==0){
		return 0; 
	}
	$('#goods_money').val(price_count.toFixed(2));
	$('#goods_num').val(num_count.toFixed(2));
	 
	
} 
 
$('.save').click(function(){
	$('form').attr('action',"{:url('edit_do')}");
});


</script>